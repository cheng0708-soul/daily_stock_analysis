# 分析口径变更追踪（防回归）

> 目标：持续追踪“评分/评价口径”变化，避免工具在迭代中偏离原有效果（“做烂”）。

## 1. 适用范围

- 仓库：`cheng0708-soul/daily_stock_analysis`
- 关注对象：
  - 个股评分（总分、信号分、风险分）
  - 趋势判断（多头/空头/震荡）
  - 买卖建议（买入/持有/观望/减仓）
  - 报告文案（是否出现风格漂移）

---

## 2. 已识别的关键变更（当前基线）

### 2.1 Workflow 配置层（间接影响）

- 新增 `AIHUBMIX_KEY`
- 新增 `ANTHROPIC_API_KEY / ANTHROPIC_MODEL`
- 新增 `MARKET_REVIEW_REGION`

影响：模型与区域配置变化可能导致结论风格和评分边际变化。

### 2.2 分析逻辑层（直接影响）

1. **盘中实时技术面接入（Issue #234）**
   - 使用实时价格拼接历史序列后重算 MA5/MA10/MA20 与趋势。
   - 盘中分数更动态，和旧版“收盘口径”可出现明显差异。

2. **乖离率规则调整（Issue #296）**
   - `BIAS_THRESHOLD` 可配置（默认 5.0）。
   - 强势趋势（强多头+趋势强度高）自动放宽阈值（1.5 倍）。

3. **数据源/回退链路增强**
   - 多数据源优先级与回退策略调整（efinance/akshare/yfinance 等）。
   - 行情数据差异会传导到评分和建议。

4. **Agent 分析链路（可选）**
   - 在特定配置下可切至 Agent 模式，分析路径与文案会变化。

5. **新闻时效筛选**
   - 引入新闻最大时效窗口，减少过时资讯干扰。

---

## 3. 防回归总原则

1. **口径先冻结，再升级**：先锁定对比参数，再做版本升级。
2. **同口径对比**：同样本、同参数、同模型、同时间窗对比新旧版本。
3. **一改一验**：每次只引入一类关键变更，避免混杂影响无法归因。
4. **异常可回滚**：保持可回滚配置，避免长时间运行在不稳定口径。

---

## 4. 每次升级必须执行的对比清单（Checklist）

## A. 运行前冻结参数

- [ ] 固定 `STOCK_LIST`（建议 10~20 个代表性样本）
- [ ] 固定模型（避免 OpenAI/Anthropic/AIHubMix 自动切换）
- [ ] 固定数据源优先级（`REALTIME_SOURCE_PRIORITY`）
- [ ] 固定 `BIAS_THRESHOLD`
- [ ] 固定是否开启 Agent 模式（`AGENT_MODE`）
- [ ] 固定新闻时效参数（`NEWS_MAX_AGE_DAYS`）

## B. 对比输出

- [ ] 输出每只股票：趋势、建议、总分、关键理由
- [ ] 统计：平均分、买入数量、强烈看多数量、风险提示数量
- [ ] 标记差异超过阈值的股票（建议阈值：`|Δscore| >= 10`）

## C. 验收阈值（建议）

- [ ] 平均分变动 ≤ 8 分
- [ ] 建议分类翻转比例 ≤ 20%
- [ ] 高风险误判（例如明显追高被判买入）为 0

不满足任一条：
- 视为“疑似口径漂移”，进入复核，不直接上生产。

---

## 5. 建议的“稳定生产参数”

> 用于日常稳定输出（可按需要调整）

- `STOCK_LIST`：固定关注池（由用户维护）
- `REALTIME_SOURCE_PRIORITY=tencent,akshare_sina,efinance,akshare_em`
- `BIAS_THRESHOLD=5.0`
- `AGENT_MODE=false`（若追求稳定一致性）
- `NEWS_MAX_AGE_DAYS=3`
- 固定单一主模型（避免自动切换带来的风格漂移）

---

## 6. 变更记录模板（每次升级必填）

```md
## 变更批次：YYYY-MM-DD / commit SHA

### 变更内容
- workflow：
- 核心逻辑：
- 配置项：

### 对比样本
- 股票池：
- 时间窗：
- 模型与参数：

### 结果
- 平均分变化：
- 建议翻转比例：
- 异常样本：

### 结论
- [ ] 可上线
- [ ] 需回滚
- [ ] 需灰度观察

### 处理动作
- 调整项：
- 负责人：
- 下次复核时间：
```

---

## 7. 执行建议（最小成本）

- 每次升级后至少手动跑 1 次 `workflow_dispatch` 做快检。
- 每周固定做一次“同口径回归对比”。
- 当出现“评分突变/建议翻转明显增多”时，优先检查：
  1) 模型是否切换
  2) 数据源是否回退
  3) BIAS / Agent / 新闻时效参数是否变更

---

## 8. 当前维护结论（2026-02-26）

- 近期评分差异显著，主要由**盘中实时口径 + 乖离率规则 + 数据源回退差异**引起。
- 当前 Telegram 推送链路已验证可用。
- 建议后续严格按本文档做“冻结参数 + 差异验收 + 记录归档”。
